/*! thread.js - v0.1 - MIT License - https://github.com/h2non/thread.js */
!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;"undefined"!=typeof window?t=window:"undefined"!=typeof global?t=global:"undefined"!=typeof self&&(t=self),t.thread=e()}}(function(){var define,module,exports;return function e(t,r,n){function i(o,a){if(!r[o]){if(!t[o]){var u=typeof require=="function"&&require;if(!a&&u)return u(o,!0);if(s)return s(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var c=r[o]={exports:{}};t[o][0].call(c.exports,function(e){var r=t[o][1][e];return i(r?r:e)},c,c.exports,e,t,r,n)}return r[o].exports}var s=typeof require=="function"&&require;for(var o=0;o<n.length;o++)i(n[o]);return i}({1:[function(e,t,r){var n=e("./utils");var i=e("./worker");var s=window.addEventListener?"addEventListener":"attachEvent";var o=s==="attachEvent"?"onmessage":"message";var a=window[s];var u=window[window.removeEventListener?"removeEventListener":"detachEvent"];t.exports=f;function f(e){this.id=e;this.listeners={};this._create();this._setupListeners();this._initialize()}f.prototype._create=function(){var e=this.iframe=document.createElement("iframe");if(!e.style)e.style={};e.style.display="none";e.id="thread-"+this.id;document.body.appendChild(e)};f.prototype._subscribeListeners=function(e){var t=this.listeners;if(s==="attachEvent")e="on"+e;function r(r){if(r.data&&r.data.owner==="thread.js"){if(t[e]){n.each(t[e],function(e){if(n.isFn(e))e(r)})}}}this._eventHandler=r;a(e,r)};f.prototype._setupListeners=function(){this._subscribeListeners("message");this._subscribeListeners("error")};f.prototype._unsubscribeListeners=function(){u("error",this._eventHandler);u("message",this._eventHandler)};f.prototype._getWindow=function(){var e=this.iframe.contentWindow;var t=e.eval,r=e.execScript;if(!t&&r){r.call(e,"null");t=e.eval}return e};f.prototype._initialize=function(e){var t=this._getWindow();t.eval.call(t,n.getSource(i))};f.prototype.addEventListener=function(e,t){var r=this.listeners[e]=this.listeners[e]||[];if(n.isFn(t))r.push(t)};f.prototype.removeEventListener=function(e,t){var r,i=this.listeners[e];if(i){if(n.isFn(t)){i.splice(0,i.length)}else{r=i.indexOf(t);if(r>=0)i.splice(r,1)}}};f.prototype.postMessage=function(e){var t=this._getWindow();e.origin=c();t.postMessage(e,e.origin)};f.prototype.terminate=function(){this.listeners=null;this._unsubscribeListeners();document.body.removeChild(this.iframe)};function c(){return location.origin||location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")}},{"./utils":7,"./worker":8}],2:[function(e,t,r){var n=e("./store");var i=e("./thread");t.exports=s;function s(e){return new i(e)}s.VERSION="0.1.4";s.create=s;s.Task=i.Task;s.Thread=i;s.total=n.total;s.running=n.running;s.idle=n.idle;s.flush=n.flush;s.killAll=s.terminateAll=n.killAll;s.killIdle=s.terminateIdle=n.killIdle},{"./store":4,"./thread":6}],3:[function(e,t,r){var n=e("./utils");t.exports=i;function i(e,t){var r=t.run;var s=[t];var o=t.options;var a=t.terminate;function u(e){var t,r,n,i;for(t=0,r=s.length;t<r;t+=1){n=s[t];i=n.pending();if(i===0||i<e){if(n.terminated){s.splice(t,1);r-=1}else{return n}}}}function f(){var e=new i.Thread(o);s.push(e);return e}function c(e,t){var n;if(e===s[0]){n=r.apply(e,t)}else{n=e.run.apply(e,t)}return n}t.run=t.exec=function(){var t=arguments;function r(n){var i,o=u(n);if(o){i=c(o,t)}else{if(s.length<e){i=c(f(),t)}else{i=r(n+1)}}return i}return r(0)};t.terminate=t.kill=function(){n.each(s,function(e,t){if(t===0)a.call(e);else e.terminate()});s.splice(0)};t.threadPool=s;t.isPool=true;return t}},{"./utils":7}],4:[function(e,t,r){var n=e("./utils");var i=[];var s=t.exports={};s.push=function(e){i.push(e)};s.all=function(){return i.slice()};s.remove=function(e){var t=i.indexOf(e);if(t>=0)i.splice(t,1)};s.flush=function(){i.splice(0)};s.total=function(){return i.length};function o(e){var t=[];n.each(i,function(r){if(r[e]())t.push(r)});return t}s.running=function(){return o("running")};s.idle=function(){return o("idle")};s.killAll=function(){var e=i.slice();n.each(e,function(e){e.kill()})};s.killIdle=function(){n.each(s.idle(),function(e){e.kill()})}},{"./utils":7}],5:[function(e,t,r){var n=e("./utils");t.exports=i;function i(e,t){this.id=n.uuid();this.thread=e;this.worker=e.worker;this.env=t||{};this.time=this.memoized=null;this.listeners={error:[],success:[],end:[]};this._subscribe()}i.intervalCheckTime=200;i.prototype._getValue=function(e){return e.type==="run:error"?o(e):e.value};i.prototype._trigger=function(e,t){if(typeof this._timer==="number")f(this);s(this,e)(this.listeners[t])};i.prototype._subscribe=function(){this.worker.addEventListener("message",l(this))};i.prototype.bind=i.prototype.set=function(e){n.extend(this.env,e);return this};i.prototype.run=i.prototype.exec=function(e,t,r){var s=this.thread;if(s._terminated)throw new Error("cannot execute the task, the thread was terminated");if(!n.isFn(e))throw new TypeError("first argument must be a function");if(n.isArr(arguments[1]))r=arguments[1];if(n.isObj(arguments[2]))t=arguments[2];t=n.serializeMap(n.extend({},this.env,t));this.memoized=null;this.time=n.now();if(s.maxTaskDelay>=i.intervalCheckTime)this._checkInterval(s.maxTaskDelay);if(s._tasks.indexOf(this)===-1)s._tasks.push(this);this["finally"](a(s,this));this._send(t,e,r);return this};i.prototype._addHandler=function(e,t){if(this.memoized){if(this.memoized.type==="run:"+e)t.call(null,this._getValue(this.memoized))}else{this.listeners[e].push(t)}};i.prototype.then=function(e,t){if(n.isFn(e))this._addHandler("success",e);if(n.isFn(t))this["catch"](t);return this};i.prototype["catch"]=function(e){if(n.isFn(e))this._addHandler("error",e);return this};i.prototype["finally"]=function(e){if(n.isFn(e)){if(this.memoized)e.call(null,this._getValue(this.memoized));else this.listeners.end.push(e)}return this};i.prototype.flush=function(){this.memoized=this.thread=null;this.worker=this.env=this.listeners=null};i.prototype.flushed=function(){return!this.thread&&!this.worker};i.prototype._send=function(e,t,r){this.worker.postMessage({id:this.id,type:"run",env:e,src:t.toString(),args:r})};i.prototype._checkInterval=function(e){var t=this,r=n.now();t._timer=setInterval(function(){if(t.memoized){f(t)}else{u(t,r,e)}},i.intervalCheckTime)};i.create=function(e){return new i(e)};function s(e,t){return function r(e){var i=null;if(n.isArr(e)){i=e.shift();if(i){i.call(null,t);if(e.length)r(e)}}}}function o(e){var t=new Error(e.error);t.name=e.errorName;t.stack=e.errorStack;return t}function a(e,t){return function(){var r=e._tasks.indexOf(t);e._latestTask=n.now();if(r>=0)e._tasks.splice(r,1)}}function u(e,t,r){var i=null;if(n.now()-t>r){i=new Error("maximum task execution time exceeded");e.memoized={type:"run:error",error:i};e._trigger(i,"error");e._trigger(i,"end");f(e)}}function f(e){clearInterval(e._timer);e._timer=null}function c(e){return e==="run:error"||e==="run:success"}function l(e){return function t(r){var n,i=r.data;if(i&&i.id===e.id){if(c(i.type)){e.worker.removeEventListener("message",t);e.memoized=i;n=e._getValue(i);e._trigger(n,i.type.split(":")[1]);e._trigger(n,"end")}}}}},{"./utils":7}],6:[function(e,t,r){var n=e("./utils");var i=e("./worker");var s=e("./task");var o=e("./fake-worker");var a=e("./pool");var u=e("./store");var f=window.URL||window.webkitURL;var c=n.isFn(window.Worker);var l=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder;t.exports=p;function p(e){this.id=n.uuid();this.terminated=false;this.options={};this._tasks=[];this._latestTask=0;this._setOptions(e);this._create()}p.prototype.isPool=false;p.prototype.maxTaskDelay=0;p.prototype.idleTime=30*1e3;p.prototype._setOptions=function(e){this.options.namespace="env";this.options.require=[];this.options.env={};n.extend(this.options,e);return this};p.prototype._create=function(){var e,t=n.getSource(i);if(f){try{e=new Blob([t],{type:"text/javascript"})}catch(r){e=new l;e.append(t);e=e.getBlob()}e=f.createObjectURL(e)}if(c&&f)this.worker=new Worker(e);else this.worker=new o(this.id);u.push(this);this.send(n.extend({type:"start"},{env:n.serializeMap(this.options.env),namespace:this.options.namespace}));this.worker.addEventListener("error",function(e){throw e});this.require(this.options.require);return this};p.prototype.require=p.prototype["import"]=function(e,t){if(n.isFn(e)){t=e;e=n.fnName(t);if(!e){throw new Error("Function must have a name")}this.send({type:"require:fn",src:t.toString(),name:n.fnName(t)})}else if(typeof e==="string"){if(n.isFn(t)){this.send({type:"require:fn",src:t.toString(),name:e})}else{if(n.isArr(this.options.require))this.options.require.push(e);this.send({type:"require:file",src:e})}}else if(n.isArr(e)){if(n.isArr(this.options.require))this.options.require=this.options.require.concat(e);this.send({type:"require:file",src:e})}else if(n.isObj(e)){this.send({type:"require:map",src:n.serializeMap(e)})}return this};p.prototype.run=p.prototype.exec=function(e,t,r){var i,o,a=this;var u=a._tasks;if(n.isArr(e)){r=e;e=arguments[1]}if(n.isArr(t)){r=t;t=arguments[2]}if(e instanceof s){i=e}else{if(!n.isFn(e))throw new TypeError("missing function argument");i=new s(this)}this._tasks.push(i);n.defer(function(){i.run(e,t,r)});return i};p.prototype.bind=p.prototype.set=function(e){this.send({type:"env",data:n.serializeMap(e)});return this};p.prototype.flush=function(){this.send({type:"flush"});this.options.env={};return this};p.prototype.flushTasks=function(){n.each(this.tasks,function(e){e.flush()});this._tasks.splice(0);return this};p.prototype.send=function(e){if(this.worker){this.worker.postMessage(e)}};p.prototype.pool=function(e){return a(e||2,this)};p.prototype.terminate=p.prototype.kill=function(){if(!this.terminated){this.options={};this.flushTasks().flush();this.terminated=true;this.worker.terminate();u.remove(this)}return this};p.prototype.start=p.prototype.init=function(e){if(this.terminated){this._setOptions(e);this._create();this.terminated=false}return this};p.prototype.pending=function(){return this._tasks.length};p.prototype.running=function(){return this._tasks.length>0};p.prototype.idle=p.prototype.sleep=function(){return!this.running()&&!this.terminated&&(this._latestTask===0||n.now()-this._latestTask>this.idleTime)};p.prototype.on=p.prototype.addEventListener=function(e,t){if(this.worker)this.worker.addEventListener(e,t);return this};p.prototype.off=p.prototype.removeEventListener=function(e,t){if(this.worker&&n.isFn(t)){this.worker.removeEventListener(e,t)}return this};p.prototype.toString=function(){return"[object Thread]"};a.Thread=p;p.Task=s},{"./fake-worker":1,"./pool":3,"./store":4,"./task":5,"./utils":7,"./worker":8}],7:[function(e,t,r){var n=r;var i=Object.prototype.toString;var s=Array.prototype.slice;var o=Array.isArray;r.now=function(){return(new Date).getTime()};r.isFn=function(e){return typeof e==="function"};r.isObj=function(e){return e&&i.call(e)==="[object Object]"};r.isArr=function(e){return e&&o?o(e):i.call(e)==="[object Array]"};r.toArr=function(e){return s.call(e)};r.defer=function(e){setTimeout(e,1)};r.each=function(e,t){var r,i;if(n.isArr(e))for(r=0,i=e.length;r<i;r+=1)t(e[r],r);else if(n.isObj(e))for(r in e)if(e.hasOwnProperty(r))t(e[r],r)};r.extend=function(e){var t=n.toArr(arguments).slice(1);n.each(t,function(t){if(n.isObj(t)){n.each(t,function(t,r){e[r]=t})}});return e};r.getSource=function(e){return"("+e.toString()+").call(this)"};r.fnName=function(e){return e.name||(e=/\W*function\s+([\w\$]+)\(/.exec(e.toString())?e[1]:"")};r.serializeMap=function(e){if(n.isObj(e)){n.each(e,function(t,r){if(n.isFn(t)){e["$$fn$$"+r]=t.toString();e[r]=undefined}})}return e};r.uuid=function(){var e="",t,r;for(t=0;t<32;t++){r=Math.random()*16|0;if(t===8||t===12||t===16||t===20)e+="-";e+=(t===12?4:t===16?r&3|8:r).toString(16)}return e}},{}],8:[function(require,module,exports){module.exports=worker;function worker(){var self=this;function $$evalExpr(expr){var fn=null;eval("fn = "+expr);return fn}(function isolated(){var namespace="env";var isWorker=self.document===undefined;var toStr=Object.prototype.toString;var slice=Array.prototype.slice;var eventMethod=self.addEventListener?"addEventListener":"attachEvent";var messageEvent=eventMethod==="attachEvent"?"onmessage":"message";var importFn=isWorker?importScripts:appendScripts;var ready=false;var queue,origin,scriptsLoad,intervalId=null;var fnRegex=/^\$\$fn\$\$/;var isArrayNative=Array.isArray;self.addEventListener=self[eventMethod];function isObj(e){return e&&toStr.call(e)==="[object Object]"}function isArr(e){return e&&isArrayNative?isArrayNative(e):toStr.call(e)==="[object Array]"}function mapFields(e){for(var t in e)if(e.hasOwnProperty(t)){if(fnRegex.test(t)){e[t.replace("$$fn$$","")]=$$evalExpr(e[t]);e[t]=undefined}else{e[t]=e[t]}}return e}function extend(e,t){var r,n,i,s=slice.call(arguments).slice(1);for(r=0,n=s.length;r<n;r+=1){t=s[r];if(isObj(t)){t=mapFields(t);for(i in t)if(t[i]!==undefined){e[i]=t[i]}}}return e}function each(e,t){var r,n;if(isArr(e)){if(e.forEach){e.forEach(t)}else{for(r=0,n=e.length;r<n;r+=1){t(e[r],r)}}}else if(isObj(e)){for(r in e)if(e.hasOwnProperty(r)){t(e[r],r)}}}function waitReady(){var e=self.document;if(e.readyState==="complete"){ready=true}else{e.onreadystatechange=function(){if(e.readyState==="complete"){ready=true}}}}function appendScript(e){var t=document.getElementsByTagName("head")[0];var r=document.createElement("script");r.type="text/javascript";r.src=e;scriptsLoad.push(r);r.onload=r.onreadystatechange=function(){if(!this.readyState||this.readyState==="loaded"||this.readyState==="complete"){scriptsLoad.splice(scriptsLoad.indexOf(r),1)}r.onload=r.onreadystatechange=null};t.appendChild(r)}function appendScripts(){var e,t,r=slice.call(arguments);for(e=0,t=r.length;e<t;e+=1){if(r[e])appendScript(r[e])}}function scriptsLoadTimer(){intervalId=setInterval(function(){if(ready&&!scriptsLoad.length){clearInterval(intervalId);each(queue,function(e){e()});queue=[];intervalId=null}},50)}function loadScripts(e){if(isArr(e)){importFn.apply(self,e)}else{importFn(e)}if(!isWorker&&!intervalId){scriptsLoadTimer()}}function require(e){if(isArr(e)||typeof e==="string"){loadScripts(e)}else if(isObj(e)){each(e,function(e,t){requireFn(t,e)})}}function requireFn(name,fn){if(fnRegex.test(name)){name=name.replace("$$fn$$","");fn=$$evalExpr(fn)}eval("self[namespace][name] = "+fn)}function postMessage(e){if(isWorker){self.postMessage(e)}else{e.owner="thread.js";self.parent.postMessage(e,origin)}}function sendError(e,t){postMessage({type:"run:error",id:e.id,error:t.message||t,errorName:t.name||null,errorStack:t.stack||null})}function sendSuccess(e,t){postMessage({type:"run:success",id:e.id,value:t})}function done(e){return function(t,r){if(t){sendError(e,t)}else{sendSuccess(e,r)}}}function process(e){var t=e.args||[];var r=$$evalExpr(e.src);var n=isObj(e.env)?mapFields(e.env):self[namespace];if(r.length===t.length+1){t.push(done(e));r.apply(n,t)}else{r=r.apply(n,t);sendSuccess(e,r)}}function run(e){function t(){try{process(e)}catch(t){sendError(e,t)}}if(!isWorker&&(!ready||scriptsLoad.length)){queue.push(t)}else{t()}}function start(e){if(e.require){require(e.require)}if(e.origin){origin=e.origin}namespace=e.namespace||namespace;self[namespace]=mapFields(e.env||{})}function flush(){self[namespace]={}}function extendEnv(e){extend(self[namespace||namespace],e.env)}function onMessage(e){var t=e.data;if(t.origin){origin=t.origin}switch(t.type){case"start":start(t);break;case"run":run(t);break;case"env":extendEnv(t);break;case"require:fn":requireFn(t.name,t.src);break;case"require:file":case"require:map":require(t.src);break;case"flush":flush();break}}if(!isWorker){scriptsLoad=[];queue=[];waitReady()}self.addEventListener(messageEvent,onMessage);self.addEventListener("error",function(e){throw e})})()}},{}]},{},[2])(2)});
//# sourceMappingURL=thread.min.js.map