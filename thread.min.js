/*! thread.js - v0.1 - MIT License - https://github.com/h2non/thread.js */
!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;"undefined"!=typeof window?t=window:"undefined"!=typeof global?t=global:"undefined"!=typeof self&&(t=self),t.thread=e()}}(function(){var define,module,exports;return function e(t,r,n){function i(o,a){if(!r[o]){if(!t[o]){var u=typeof require=="function"&&require;if(!a&&u)return u(o,!0);if(s)return s(o,!0);var c=new Error("Cannot find module '"+o+"'");throw c.code="MODULE_NOT_FOUND",c}var f=r[o]={exports:{}};t[o][0].call(f.exports,function(e){var r=t[o][1][e];return i(r?r:e)},f,f.exports,e,t,r,n)}return r[o].exports}var s=typeof require=="function"&&require;for(var o=0;o<n.length;o++)i(n[o]);return i}({1:[function(e,t,r){var n=e("./utils");var i=e("./worker");var s=window.addEventListener?"addEventListener":"attachEvent";var o=s==="attachEvent"?"onmessage":"message";var a=window[s];var u=window[window.removeEventListener?"removeEventListener":"detachEvent"];t.exports=c;function c(e){this.listeners={};this.id=e;this._create();this._setupListeners();this._initialize()}c.prototype._create=function(){var e=this.iframe=document.createElement("iframe");if(!e.style)e.style={};e.style.display="none";e.id="thread-"+this.id;document.body.appendChild(e)};c.prototype._subscribeListeners=function(e){var t=this.listeners;if(s==="attachEvent")e="on"+e;function r(r){if(r.data&&r.data.owner==="thread.js"){if(t[e]){n.each(t[e],function(e){if(n.isFn(e))e(r)})}}}this._eventHandler=r;a(e,r)};c.prototype._setupListeners=function(){this._subscribeListeners("message");this._subscribeListeners("error")};c.prototype._unsubscribeListeners=function(){u("error",this._eventHandler);u("message",this._eventHandler)};c.prototype._getWindow=function(){var e=this.iframe.contentWindow;var t=e.eval,r=e.execScript;if(!t&&r){r.call(e,"null");t=e.eval}return e};c.prototype._initialize=function(e){var t=this._getWindow();t.eval.call(t,n.getSource(i))};c.prototype.addEventListener=function(e,t){var r=this.listeners[e]=this.listeners[e]||[];if(n.isFn(t))r.push(t)};c.prototype.removeEventListener=function(e,t){var r,i=this.listeners[e];if(i){if(n.isFn(t)){i.splice(0,i.length)}else{r=i.indexOf(t);if(~r){i.splice(r,1)}}}};c.prototype.postMessage=function(e){var t=this._getWindow();e.origin=f();t.postMessage(e,e.origin)};c.prototype.terminate=function(){this.listeners=null;this._unsubscribeListeners();document.body.removeChild(this.iframe)};function f(){return location.origin||location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")}},{"./utils":6,"./worker":7}],2:[function(e,t,r){var n=e("./thread");t.exports=i;function i(e){return new n(e)}i.VERSION="0.1.0";i.create=i;i.Task=n.Task;i.Thread=n},{"./thread":5}],3:[function(e,t,r){var n=e("./utils");t.exports=i;function i(e,t){var r=t.run;var s=[t];var o=t.options;var a=t.terminate;function u(e){var t,r,n;for(t=0,r=s.length;t<r;t+=1){n=s[t];if(n.pending()<=e){return n}}}function c(){var e=new i.Thread(o);s.push(e);return e}t.run=function(){var t=arguments;var n=0;function i(e){var n;if(e===s[0]){n=r.apply(e,t)}else{n=e.run.apply(e,t)}return n}function o(t){var r,n=u(t);if(n){r=i(n)}else{if(s.length<e){r=i(c())}else{r=o(t+1)}}return r}return o(n)};t.terminate=t.kill=function(){n.each(s,function(e,t){if(t===0)a();else e.terminate()});s.splice(0)};t.threadPool=s;return t}},{"./utils":6}],4:[function(e,t,r){var n=e("./utils");t.exports=i;function i(e){this.id=n.generateUUID();this.thread=e;this.worker=e._worker;this.env={};this.time=this.memoized=null;this.listeners={error:[],success:[],end:[]};this._subscribe()}i.prototype._buildError=function(e){var t=new Error(e.error);t.name=e.errorName;t.stack=e.errorStack;return t};i.prototype._getValue=function(e){return e.type==="run:error"?this._buildError(e):e.value};i.prototype._trigger=function(e,t){(function r(t){var n=t.shift();if(n){n(e);if(t.length)r(t)}})(this.listeners[t])};i.prototype._subscribe=function(){var e=this;this.worker.addEventListener("message",t);function t(r){var n;var i=r.data;var s=i.type;var o=e.listeners;if(i&&i.id===e.id){if(s==="run:error"||s==="run:success"){e.worker.removeEventListener("message",t);e.memoized=r.data;i=e._getValue(i);e._trigger(i,s.split(":")[1]);e._trigger(i,"end")}}}};i.prototype.setEnv=function(e){n.extend(this.env,e);return this};i.prototype.run=function(e,t,r){var i;this.time=(new Date).getTime();if(!n.isFn(e)){throw new TypeError("first argument must be a function")}t=n.extend({},this.env,t);this.memoized=null;i=this.thread.maxTaskDelay;if(i>250){s(i,this)}this.worker.postMessage({id:this.id,type:"run",env:t,src:e.toString(),args:r});return this};i.prototype.then=function(e,t){if(n.isFn(e)){if(this.memoized){if(this.memoized.type==="run:success")e(this._getValue(this.memoized))}else{this.listeners.success.push(e)}}if(n.isFn(t)){this.catch(t)}return this};i.prototype.catch=function(e){if(n.isFn(e)){if(this.memoized){if(this.memoized.type==="run:error")e(this._getValue(this.memoized))}else{this.listeners.error.push(e)}}return this};i.prototype.finally=function(e){if(n.isFn(e)){if(this.memoized){e(this._getValue(this.memoized))}else{this.listeners.end.push(e)}}return this};i.prototype.flush=function(){this.memoized=this.worker=this.env=null};i.create=function(e){return new i(e)};function s(e,t){var r=(new Date).getTime();var n=setInterval(function(){if(t.memoized){return clearInterval(n)}if((new Date).getTime()-r>e){var i=new Error("maximum task execution exceeded");t.memoized={type:"run:error",error:i};t._trigger(i,"error");t._trigger(i,"end");clearInterval(n)}},250)}},{"./utils":6}],5:[function(e,t,r){var n=e("./utils");var i=e("./worker");var s=e("./task");var o=e("./fake-worker");var a=e("./pool");var u=window.URL||window.webkitURL;var c=n.isFn(window.Worker);t.exports=f;function f(e){this.options={};this._terminated=false;this.maxTaskDelay=5*1e3;this.id=n.generateUUID();this._setOptions(e);this._tasks=[];this._create()}f.prototype._setOptions=function(e){this.options.namespace="env";this.options.require=[];this.options.env={};n.extend(this.options,e);return this};f.prototype._create=function(){var e,t=n.getSource(i);if(u){try{e=new Blob([t],{type:"text/javascript"})}catch(r){e=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder);e.append(t);e=e.getBlob()}e=u.createObjectURL(e)}if(c&&u){this._worker=new Worker(e)}else{this._worker=new o(this.id)}this.send(n.extend({type:"start"},{env:this.options.env,namespace:this.options.namespace}));this._worker.addEventListener("error",function(e){throw e});this.require(this.options.require);return this};f.prototype._serializeMap=function(e){n.each(e,function(t,r){if(n.isFn(t)){e["$$fn$$"+r]=t.toString();e[r]=undefined}else{e[r]=t}});return e};f.prototype.require=function(e,t){if(n.isFn(e)){t=e;e=n.fnName(t);if(!e){throw new Error("Function must have a name")}this.send({type:"require:fn",src:t.toString(),name:n.fnName(t)})}else if(typeof e==="string"){if(n.isFn(t)){this.send({type:"require:fn",src:t.toString(),name:e})}else{this.send({type:"require:file",src:e})}}else if(n.isArr(e)){this.send({type:"require:file",src:e})}else if(n.isObj(e)){this.send({type:"require:map",src:this._serializeMap(e)})}return this};f.prototype.run=f.prototype.exec=function(e,t,r){var i,o,a=this;var u=a._tasks;if(n.isArr(e)){r=e;e=arguments[1]}if(n.isArr(t)){r=t;t=arguments[2]}if(!n.isFn(e)){throw new TypeError("missing function argument")}if(e instanceof s){i=e}else{i=new s(this)}u.push(i);i.finally(function(){u.splice(u.indexOf(i),1)});n.defer(function(){i.run(e,t,r)});return i};f.prototype.bind=function(e){this.send({type:"env",data:this._serializeMap(e)});return this};f.prototype.flush=function(){this.send({type:"flush"});this.options.env={};return this};f.prototype.flushTasks=function(){n.each(this.tasks,function(e){e.flush()});this._tasks.splice(0);return this};f.prototype.send=function(e){if(this._worker){this._worker.postMessage(e)}};f.prototype.pool=function(e){e=e||2;return a(e,this)};a.Thread=f;f.prototype.terminate=f.prototype.kill=function(){if(!this._terminated){this.options={};this.flushTasks().flush();this._terminated=true;this._worker.terminate()}return this};f.prototype.start=f.prototype.init=function(e){if(this._terminated){this._setOptions(e);this._create();this._terminated=false}return this};f.prototype.pending=function(){return this._tasks.length};f.prototype.isRunning=function(){return this._tasks.length>0};f.Task=s},{"./fake-worker":1,"./pool":3,"./task":4,"./utils":6,"./worker":7}],6:[function(e,t,r){var n=r;var i=Object.prototype.toString;var s=Array.prototype.slice;r.isFn=function o(e){return typeof e==="function"};r.isObj=function a(e){return e&&i.call(e)==="[object Object]"};r.isArr=function u(e){return e&&i.call(e)==="[object Array]"};r.toArr=function c(e){return s.call(e)};r.defer=function f(e){setTimeout(e,1)};r.bind=function p(e,t){return function(){t.apply(e,arguments)}};r.each=function l(e,t){var r,i;if(n.isArr(e)){for(r=0,i=e.length;r<i;r+=1){t(e[r],r)}}else if(n.isObj(e)){for(r in e)if(e.hasOwnProperty(r)){t(e[r],r)}}};r.extend=function d(e){var t=n.toArr(arguments).slice(1);n.each(t,function(t){n.each(t,function(t,r){e[r]=t})});return e};r.clone=function h(e){return n.extend({},e)};r.getSource=function v(e){return"("+e.toString()+").call(this)"};r.fnName=function m(e){return e.name||/\W*function\s+([\w\$]+)\(/.exec(e.toString())[1]};r.generateUUID=function y(){var e=(new Date).getTime();var t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var r=(e+Math.random()*16)%16|0;e=Math.floor(e/16);return(t=="x"?r:r&7|8).toString(16)});return t}},{}],7:[function(require,module,exports){module.exports=worker;function worker(){var self=this;function $$evalExpr(expr){var fn=null;eval("fn = "+expr);return fn}(function isolated(){var namespace="env";var isWorker=self.document===undefined;var toStr=Object.prototype.toString;var slice=Array.prototype.slice;var eventMethod=self.addEventListener?"addEventListener":"attachEvent";var messageEvent=eventMethod==="attachEvent"?"onmessage":"message";var importFn=isWorker?importScripts:appendScripts;var ready=false;var queue,origin,scriptsLoad,intervalId=null;var fnRegex=/^\$\$fn\$\$/;self.addEventListener=self[eventMethod];function isObj(e){return e&&toStr.call(e)==="[object Object]"}function isArr(e){return e&&Array.isArray?Array.isArray(e):toStr.call(e)==="[object Array]"}function extend(e,t){var r,n,i,s=slice.call(arguments).slice(1);for(r=0,n=s.length;r<n;r+=1){t=s[r];if(isObj(t)){for(i in t)if(t.hasOwnProperty(i)){if(fnRegex.test(i)){e[i.replace("$$fn$$","")]=$$evalExpr(t[i])}else{e[i]=t[i]}}}}return e}function each(e,t){var r,n;if(isArr(e)){if(e.forEach){e.forEach(t)}else{for(r=0,n=e.length;r<n;r+=1){t(e[r],r)}}}else if(isObj(e)){for(r in e)if(e.hasOwnProperty(r)){t(e[r],r)}}}function waitReady(){var e=self.document;if(e.readyState==="complete"){ready=true}else{e.onreadystatechange=function(){if(e.readyState==="complete"){ready=true}}}}function appendScript(e){var t=document.getElementsByTagName("head")[0];var r=document.createElement("script");r.type="text/javascript";r.src=e;scriptsLoad.push(r);r.onload=r.onreadystatechange=function(){if(!this.readyState||this.readyState==="loaded"||this.readyState==="complete"){scriptsLoad.splice(scriptsLoad.indexOf(r),1)}r.onload=r.onreadystatechange=null};t.appendChild(r)}function appendScripts(){var e,t,r=slice.call(arguments);for(e=0,t=r.length;e<t;e+=1){if(r[e])appendScript(r[e])}}function scriptsLoadTimer(){intervalId=setInterval(function(){if(ready&&!scriptsLoad.length){clearInterval(intervalId);each(queue,function(e){e()});queue=[];intervalId=null}},50)}function loadScripts(e){if(isArr(e)){importFn.apply(self,e)}else{importFn(e)}if(!isWorker&&!intervalId){scriptsLoadTimer()}}function require(e){if(isArr(e)||typeof e==="string"){loadScripts(e)}else if(isObj(e)){each(e,function(e,t){requireFn(t,e)})}}function requireFn(name,fn){if(fnRegex.test(name)){name=name.replace("$$fn$$","");fn=$$evalExpr(fn)}eval("self[namespace][name] = "+fn)}function postMessage(e){if(isWorker){self.postMessage(e)}else{e.owner="thread.js";self.parent.postMessage(e,origin)}}function sendError(e,t){postMessage({type:"run:error",id:e.id,error:t.message||t,errorName:t.name||null,errorStack:t.stack||null})}function sendSuccess(e,t){postMessage({type:"run:success",id:e.id,value:t})}function done(e){return function(t,r){if(t){sendError(e,t)}else{sendSuccess(e,r)}}}function process(e){var t=e.args||[];var r=$$evalExpr(e.src);var n=isObj(e.env)?e.env:self[namespace];if(r.length===t.length+1){t.push(done(e));r.apply(n,t)}else{r=r.apply(n,t);sendSuccess(e,r)}}function run(e){function t(){try{process(e)}catch(t){sendError(e,t)}}if(!isWorker&&(!ready||scriptsLoad.length)){queue.push(t)}else{t()}}function start(e){if(e.require){require(e.require)}if(e.origin){origin=e.origin}namespace=e.namespace||namespace;self[namespace]=e.env||{}}function flush(){self[namespace]={}}function extendEnv(e){extend(self[namespace||namespace],e.env)}function onMessage(e){var t=e.data;if(t.origin){origin=t.origin}switch(t.type){case"start":start(t);break;case"run":run(t);break;case"env":extendEnv(t);break;case"require:fn":requireFn(t.name,t.src);break;case"require:file":case"require:map":require(t.src);break;case"flush":flush();break}}if(!isWorker){scriptsLoad=[];queue=[];waitReady()}self.addEventListener(messageEvent,onMessage);self.addEventListener("error",function(e){throw e})})()}},{}]},{},[2])(2)});