<html>
  <head>
    <meta charset="utf-8">
  </head>
  <body>
    <script src="../thread.js"></script>
    <script>
      var results = []
      var tasks = 30
      var worker = thread({ env: { x: 2 } }).pool(5)

      function run(id) {
        return function () {
          console.log('Running task:', id)
          worker.run(function (num, done) {
            return setTimeout(function () {
              done(null, Math.round(env.x * num * Math.random() * 100))
            }, Math.random() * 1000)
          }, [ 2 ]).then(function (value) {
            console.log('Result:', value)
            results.push(value)
          })
        }
      }

      function runTasks() {
        var i = 0
        while (i < tasks) {
          setTimeout(run(i), Math.random() * 1000)
          i += 1
        }
      }

      runTasks()

      var intervalId = setInterval(function () {
        if (results.length === tasks) {
          clearInterval(intervalId)
          console.log('Results:', results)
          console.log('Used threads:', worker.threadPool.length)
          worker.kill() // kill all threads
        }
      }, 250)
    </script>
  </body>
</html>
